{% load static %}

<!DOCTYPE html>
<html>
<head>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/rain.css' %}">
    <link rel="stylesheet" href="{% static 'css/thunder.css' %}">
    <link rel="stylesheet" href="{% static 'css/snow.css' %}">
    <link rel="stylesheet" href="{% static 'css/mornig_sun.css' %}">
    <link rel="stylesheet" href="{% static 'css/noon_sun.css' %}">
    <link rel="stylesheet" href="{% static 'css/moon.css' %}">

    <title>Animated Horse</title>
    <meta name="viewport" content="width=device-width, initial-scale=0.4">
    <style>
        body {
            background-color: #ADD8E6;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
        }
        .editable {
            font-size: 16px; 
            position: relative;
        }

        .editable:after {
            content: "";
            position: absolute;
            top: 0;
            left: 130ch;
            width: 3px; /* Adjust this to change the line thickness */
            height: 100%;
            background: black; /* Change this to your desired color */
        }
        table {
            border-collapse: collapse;
        }

        td {
            border: 1px solid black;
            padding: 5px;
        }


        .centered-button {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .large-button {
            font-size: 24px;  /* ã“ã®å€¤ã‚’èª¿æ•´ã—ã¦ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã®å¤§ãã•ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ */
            padding: 10px 24px;  /* ã“ã®å€¤ã‚’èª¿æ•´ã—ã¦ãƒœã‚¿ãƒ³è‡ªä½“ã®å¤§ãã•ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ */
        }

        .centered-text {
            position: fixed;
            top: 50%;
            left: 150%;
            transform: translate(-50%, -50%);
            font-size: 32px;  /* ã“ã®å€¤ã‚’èª¿æ•´ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã®å¤§ãã•ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ */
        }

        /* çµµæ–‡å­—ã®å¤§ãã•*/
        .emoji {
            display: inline-block; 
            width: 16px; /* çµµæ–‡å­—ã®å¹…ã‚’16pxã«è¨­å®š */
            text-align: center; /* çµµæ–‡å­—ã‚’ä¸­å¤®æƒãˆã«è¨­å®š */
        }

        .message45 {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: red;
            background: white;
            padding: 10px;
            display: none;
        }

        @keyframes animalsemoji {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
        }
        
        .animalsemoji {
            display: inline-block;
            animation: animalsemoji 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }

        /* ã‚´ãƒ¼ãƒ«æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹é †ä½ */
        #goal-messages {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }
        .goal-message {
            background-color: #333;  /* Dark background for contrast */
            color: #fff;  /* White text color */
            padding: 10px;  /* Some padding for spacing */
            margin: 10px;  /* Some margin for spacing */
            border-radius: 5px;  /* Rounded corners */
        }

        #start-race {
            position: fixed;
            bottom: 45px;
            right: 8%; 
        } 

        /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºç”¨ã®ç”»é¢æ¨ªå‘ãã—ã¦ãã ã•ã„ã®è¡¨ç¤º*/
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
          }
          
          .modal-content {
            background-color: #fefefe;
            margin: 50% auto; /* 15% from the top and centered */
            padding: 100px;
            border: 1px solid #888;
            width: 100%; /* Could be more or less, depending on screen size */
          }


          /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºï¼ˆæ¨ªç”»é¢ï¼‰ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
          @media screen and (orientation: landscape) and (max-width: 600px){
              /* ã“ã“ã«æ¨ªå‘ãã®æ™‚ã«é©ç”¨ã—ãŸã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›¸ã */
              .editable {
                  font-size: 14px; 
              }
              .large-button {
                  font-size: 20px;
                  padding: 8px 20px;
              }
          
              .centered-text {
                  font-size: 28px;
              }
          
              .emoji {
                  width: 14px;
              }
          
              .message45 {
                  font-size: 1.5em;
              }
          
              /* #goal-messages {
                  position: fixed; 
                  bottom: 38%;
                  left: 0;
                  flex-direction: row;
              } */
              #start-race {
                  position: fixed;
                  top: 750px;
                  left: 1200px;
                  width: 90px;
                  height: 50px;
              }
            }

    </style>
</head>
<body>


    <div id="modal" class="modal">
        <div class="modal-content">
          ã“ã®ãƒšãƒ¼ã‚¸ã¯æ¨ªå‘ãã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¨ªã«ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
    <p id="emojiOutput"></p><!-- å¤©æ°—ã«å¿œã˜ã¦çµµæ–‡å­—ã‚’è¡¨ç¤ºã§ãã‚‹ -->
    <p id="weatherOutput"></p><!-- ç¾åœ¨ã®å¤©æ°—ã‚’è¡¨ç¤ºã§ãã‚‹-->
    <p id="timeOutput"></p> <!--ç¾åœ¨ã®æ™‚é–“å¸¯ã‚’è¡¨ç¤ºã§ãã‚‹ -->

    <audio id="bgm" src="{% static 'audio/race_bgm.mp3' %}"></audio>
    <br>
    <br><br><br>

    <div id="racetable"></div> 
    <div>ğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµ</div>
    <div id="animalsemoji1"></div>
    <div>ğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµ</div>
    <div>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</div>
    <div id="editable1" class="editable" contenteditable="true">{{horse.emoji}}</div>
    <div>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</div>
    {% for cpu_horse in cpu_horses %}
    <div id="editable{{ forloop.counter0|add:2 }}" class="editable" contenteditable="true">{{cpu_horse.emoji}}</div>
    <div>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</div>
    {% endfor %}
    <div>ğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµ</div>
    <div id="animalsemoji2"></div>
    <div>ğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµğŸªµ</div>
    <div class="modal" tabindex="-1" role="dialog" id="countdownModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-body">
                <h1 id="countdown" class="text-center"></h1>
            </div>
        </div>
    </div>
</div>



<!-- 10 messages to show the goal status -->
<div id="message1"></div>
<div id="message2"></div>
<div id="message3"></div>
<div id="message4"></div>
<div id="message45" class="message45"></div>
<div id="message6"></div>
<div id="message7"></div>
<div id="message8"></div>
<div id="message9"></div>
<div id="message10"></div>
<div id="goal-line"></div>

<!-- Add this somewhere inside your body tag -->
<div id="goal-messages"></div>

<button id="start-race" class=" btn btn-primary ml-3 centered-button large-button" >å‡ºèµ°</button> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <button id="toggleButton" class=" btn btn-primary ml-3 centered-button">éè¡¨ç¤º</button>
    <table id="myTable">
<div id="tableContainer"></div>
</table>

    <script>

        window.addEventListener("load", function() {
            var modal = document.getElementById('modal');
            if (window.matchMedia("(orientation: portrait)").matches) {
                modal.style.display = "block";
            }
        
            window.addEventListener("orientationchange", function() {
                if (window.orientation === 90 || window.orientation === -90) {
                    modal.style.display = "none";
                }
            }, false);
        }, false);


        var $j = jQuery.noConflict();
        function createLightning() {//é›·ã®ä½œæˆé–¢æ•°

            var weather = localStorage.getItem('weather');//race_venueã‹ã‚‰å–å¾—ã€€å¤©æ°—
            if(weather !== 'thunder'){
                return;
            }
            var path = document.getElementById('thunder');
            var height = window.innerHeight;
            var width = window.innerWidth;
            var startX = Math.random() * width;
            var startY = 0;
            var endX = Math.random() * width;
            var endY = height;

            var points = [startX, startY];
            while (endY - startY > 50) {
                startX = startX + (Math.random() - 0.5) * 200;
                startY = startY + Math.random() * 100;
                points.push(startX, startY);
            }
            points.push(endX, endY);
        
            path.setAttribute('d', 'M' + points.join(' '));
        }
        setInterval(createLightning, 300);
        
        function setWeatherAndTime(characters) {//å¤©æ°—ã¨æ™‚é–“å¸¯ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ä½œæˆ
            var weather = localStorage.getItem('weather');//race_venueã‹ã‚‰å–å¾—ã€€å¤©æ°—
            var time = localStorage.getItem('time');//race_venueã‹ã‚‰å–å¾—ã€€æ™‚é–“å¸¯
        
            // Remove any existing weather/time elements
            var existingWeatherElement = document.getElementById('weather-element');
            if (existingWeatherElement) {
                document.body.removeChild(existingWeatherElement);
            }

            // document.getElementById("weatherOutput").innerHTML = "ä»Šæ—¥ã®å¤©æ°—ã¯" + weather + "ã§ã™";
            // Create a new weather element based on the current weather
            var newWeatherElement;
            switch(weather) {
                case "sunny":
                    break;
                case "rain":
                newWeatherElement = document.createElement('div');
                newWeatherElement.classList.add('rains');
                newWeatherElement.id = 'rains';  // Set the ID of the new element
                for (let i = 0; i < 20; i++) {  // Increase the number of raindrops from 20 to 40
                    newWeatherElement.appendChild(document.createElement('span'));
                }
                    break;
                case "snow":
                    var addSnow = 0;
                    for(let i = 0; i < characters.length; ++i) {
                        if (characters[i].traits.some(trait => trait.id === 1)) {
                            addSnow = 20;
                        }
                    }

                    // 30å€‹ã®é›ªè¦ç´ ã‚’ç”Ÿæˆ
                    for (let i = 0; i < (20 + addSnow); i++) {
                        // é›ªè¦ç´ ã®ç”Ÿæˆ
                        const newWeatherElement = document.createElement('div');
                        newWeatherElement.classList.add('snow');
                        newWeatherElement.textContent = 'â—';

                        // é›ªè¦ç´ ã®åˆæœŸä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
                        newWeatherElement.style.left = Math.random() * (window.innerWidth / 3) + 'px';
                        newWeatherElement.style.top = Math.random() * window.innerHeight + 'px';
                    
                        // é›ªè¦ç´ ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚é–“ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®šï¼ˆè² ã®å€¤ï¼‰
                        newWeatherElement.style.animationDelay = -Math.random() * 5 + 's';

                        // é›ªè¦ç´ ã‚’bodyè¦ç´ ã«è¿½åŠ 
                        document.body.appendChild(newWeatherElement);
                    }
                    break;
                case "thunder":

                    // create a svg element
                    newWeatherElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    newWeatherElement.id = 'svg';
                    newWeatherElement.style.position = 'fixed';
                    newWeatherElement.style.top = '0';
                    newWeatherElement.style.left = '0';
                    newWeatherElement.style.width = '100%';
                    newWeatherElement.style.height = '75%';
                    newWeatherElement.style.zIndex = '-1';
                    newWeatherElement.style.pointerEvents = 'none';

                    // create defs element
                    var defsElement = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

                    // create filter element
                    var filterElement = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
                    filterElement.id = 'glow';

                    // create feGaussianBlur element
                    var feGaussianBlurElement = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
                    feGaussianBlurElement.setAttribute('stdDeviation', '2.5');
                    feGaussianBlurElement.setAttribute('result', 'coloredBlur');

                    // create feMerge element
                    var feMergeElement = document.createElementNS('http://www.w3.org/2000/svg', 'feMerge');

                    // create feMergeNode elements
                    var feMergeNode1 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
                    feMergeNode1.setAttribute('in', 'coloredBlur');
                    var feMergeNode2 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
                    feMergeNode2.setAttribute('in', 'SourceGraphic');

                    // create path element
                    var pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.id = 'thunder';
                    pathElement.setAttribute('stroke', 'white');
                    pathElement.setAttribute('stroke-width', '2');
                    pathElement.setAttribute('fill', 'none');
                    pathElement.setAttribute('filter', 'url(#glow)');

                    // append elements
                    feMergeElement.appendChild(feMergeNode1);
                    feMergeElement.appendChild(feMergeNode2);
                    filterElement.appendChild(feGaussianBlurElement);
                    filterElement.appendChild(feMergeElement);
                    defsElement.appendChild(filterElement);
                    newWeatherElement.appendChild(defsElement);
                    newWeatherElement.appendChild(pathElement);
                    break;
            }
            
            // Add the new weather element to the body
            if (newWeatherElement) {
                newWeatherElement.id = 'weather-element';
                document.body.appendChild(newWeatherElement);
            }
        
            // Set time of day
            switch(time) {
                case "morning":
                    document.body.style.backgroundColor = "#aDf0ff";

                    var taiyoDiv = document.createElement('div');
                    taiyoDiv.className = 'mtaiyo';

                    var me1Div = document.createElement('div');
                    me1Div.className = 'parts me1';
                    taiyoDiv.appendChild(me1Div);

                    var me2Div = document.createElement('div');
                    me2Div.className = 'parts me2';
                    taiyoDiv.appendChild(me2Div);

                    var kuchiDiv = document.createElement('div');
                    kuchiDiv.className = 'parts kuchi';
                    taiyoDiv.appendChild(kuchiDiv);

                    document.body.appendChild(taiyoDiv);

                    taiyoDiv.addEventListener('click', function() {
                        // 'yurayura'ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                        this.classList.add('yurayura');

                        // 1ç§’å¾Œã« 'yurayura' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                        setTimeout(() => { this.classList.remove('yurayura'); }, 1500);
                    });



                    break;
                case "noon":
                    document.body.style.backgroundColor = "rgba(234, 234, 70, 0.65)";
                    document.body.style.opacity = 0.7;

                    var taiyoDiv = document.createElement('div');
                    taiyoDiv.className = 'ntaiyo';

                    var me1Div = document.createElement('div');
                    me1Div.className = 'parts me1';
                    taiyoDiv.appendChild(me1Div);

                    var me2Div = document.createElement('div');
                    me2Div.className = 'parts me2';
                    taiyoDiv.appendChild(me2Div);

                    var kuchiDiv = document.createElement('div');
                    kuchiDiv.className = 'parts kuchi';
                    taiyoDiv.appendChild(kuchiDiv);

                    document.body.appendChild(taiyoDiv);

                    break;
                case "night":
                document.body.style.backgroundColor = "#6060c3";

                var moonDiv = document.createElement('div');
                moonDiv.className = 'moon';

                document.body.appendChild(moonDiv);

                moonDiv.addEventListener('click', function(){
                    // ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¤‰æ›´ã™ã‚‹æ–°ã—ã„ã‚¯ãƒ©ã‚¹åã«æ›´æ–°ã—ã¾ã™
                    moonDiv.className = 'changedMoon';
                
                    // bodyè¦ç´ ã«flashã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦ä¸€ç¬æ˜ã‚‹ãã—ã¾ã™
                    document.body.className = 'flash';
                
                });
                    break;
            }
            return [weather, time];
        }


        function updateTable() {
            // æ—¢å­˜ã®è¡Œã‚’ã‚¯ãƒªã‚¢
            let rows = table.getElementsByTagName('tr');
            for (let i = rows.length - 1; i > 0; i--) {
                table.removeChild(rows[i]);
            }
        
            for(let i = 0; i < characters.length; ++i) {
                let row = document.createElement("tr");
                row.id = `character-${i}`;
                        
                let staminaColor = characters[i].stamina <= 25 ? 'blue' : characters[i].stamina <= 50 ? 'lime' : characters[i].stamina <= 75 ? 'red' : 'purple';
                let speedColor = characters[i].speed <= 25 ? 'blue' : characters[i].speed <= 50 ? 'lime' : characters[i].speed <= 75 ? 'red' : 'purple';
                let luckColor = characters[i].luck <= 25 ? 'blue' : characters[i].luck <= 50 ? 'lime' : characters[i].luck <= 75 ? 'red' : 'purple';
                        
                let traits = '';
                for(let j = 0; j < characters[i].traits.length; ++j) {
                    traits += characters[i].traits[j].name;
                    if(j !== characters[i].traits.length - 1) {
                        traits += ', '; // æœ€å¾Œã®ç‰¹æ€§ã§ãªã‘ã‚Œã°ã€ã‚«ãƒ³ãƒã¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
                    }
                }
            
                row.innerHTML = `<td>ç¬¬${i + 1}ãƒ¬ãƒ¼ãƒ³ã€€</td>
                    <td>${characters[i].name}ã€€</td>
                    <td style="color: ${staminaColor}">${characters[i].stamina.toFixed(0)}ã€€</td>
                    <td style="color: ${speedColor}">${characters[i].speed.toFixed(0)}ã€€</td>
                    <td style="color: ${luckColor}">${characters[i].luck.toFixed(0)}ã€€</td>
                    <td>${speeds[i].toFixed(2)}ã€€</td>
                    <td>${probabilities[i].toFixed(2)}ã€€</td>
                    <td>${traits}</td>`;
                table.appendChild(row);
            }
            let tableContainer = document.getElementById('tableContainer');

            tableContainer.appendChild(table);
        }

        var counts = Array(10).fill(0); //é€²ã‚“ã ãƒã‚¹
        var speeds = Array(10); // é »åº¦
        var startDashSpeeds = Array(10);//ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥æ™‚ã®é »åº¦
        var probabilities = Array(10);//ç¢ºç‡
        var startDashChanged = Array(10).fill(false);//ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãŒèµ·ã“ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        var speedChanged = Array(10).fill(false);//ä¸­ç›¤ã®å¤‰åŒ–ãŒèµ·ã“ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        var lateSpeedChanged = Array(10).fill(false);//å¾ŒåŠã®å¤‰åŒ–ãŒèµ·ã“ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        var lastSprintChanged = Array(10).fill(false);//ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆãŒèµ·ã“ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        var traits23Changed = Array(10).fill(false);
        var traits24Changed = Array(10).fill(false);
        var traits25Changed = Array(10).fill(false);
        var traits26Changed = Array(10).fill(false);
        var traits27Changed = Array(10).fill(false);
        var traits45Changed = Array(10).fill(false);
        var traits46Changed = Array(10).fill(false);
        var traits49Changed = Array(10).fill(false);
        var timeStopCount = Array(10).fill(false);
        var isPaused = Array(10).fill(false);
        var positionFrag = false;
        let failCounts = Array(10).fill(0);//å¤±æ•—ã—ãŸå›æ•°
        var traitsDisabled = false;
        var place = 1;
        var finishedEmojis = [];
        var emojis = ['{{ horse.emoji }}', {% for cpu_horse in cpu_horses %}'{{ cpu_horse.emoji }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        var space = '\u3000';
        var special14 = 'ğŸŒ¸';
        var special15 = 'ğŸ’£';
        var special16 = 'ğŸ†';
        var special17 = 'ğŸ‘ ';
        var special18 = 'ğŸ';
        var special38 = Array(4).fill(0);
        var special39 = 'ğŸ’©';

        {% comment %} è¦³å®¢ã®å‹•ç‰©ãŸã¡ã‚’è¡¨ç¤ºã•ã›ã‚‹å‡¦ç† {% endcomment %}
        var animalsemoji = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ¼", "ğŸ»", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ¦‰", "ğŸ´", "ğŸ¦„", "ğŸ¦“", "ğŸ¦", "ğŸ™â€â™‚ï¸", "ğŸ¦¦", "ğŸº", "ğŸ—", "ğŸ¢", "ğŸ³", "ğŸº", "ğŸ—", "ğŸ¢"];
        
        function getRandomEmoji() {
            var index = Math.floor(Math.random() * animalsemoji.length);
            return animalsemoji[index];
        }

        window.onload = function() {
            // ç‰¹å®šã®divã‚¿ã‚°ã®id
            var divIds = ['animalsemoji1', 'animalsemoji2'];
        
            divIds.forEach(function(id) {
                var div = document.getElementById(id);
                if (div) {
                    // è¡¨ç¤ºã—ãŸã„å‹•ç‰©ã®æ•°
                    var numAnimals = 37;
                    // çµµæ–‡å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã¦çµåˆã™ã‚‹
                    var animals = '';
                    for (var i = 0; i < numAnimals; i++) {
                        var emoji = getRandomEmoji();
                        var delay = Math.random() * 10;  // 0ã‹ã‚‰10ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ã‚£ãƒ¬ã‚¤
                        animals += `<span class="animalsemoji" style="animation-delay: ${delay}s">${emoji}</span>ã€€`;  // çµµæ–‡å­—ã®å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
                    }
                    // ç”Ÿæˆã—ãŸçµµæ–‡å­—ã‚’divã‚¿ã‚°ã«è¨­å®šã™ã‚‹
                    div.innerHTML = animals;
                }
            });
        };
        {% comment %} è¦³å®¢ã®å‹•ç‰©ãŸã¡ã‚’è¡¨ç¤ºã•ã›ã‚‹å‡¦ç† {% endcomment %}


        var characters = [
            {
                name: "{{horse.name}}",
                emoji:"{{horse.emoji}}",
                speed: {{horse.speed}} ,
                stamina: {{horse.stamina}},
                luck: {{horse.luck}},
                traits: [
                    {% for trait in horse.traits.all %}
                        {
                            id: {{ trait.id }},
                            name: "{{ trait.name }}",
                            description: "{{ trait.description }}"
                        }{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                ]
            }
        ];

        {% for cpu_horse in cpu_horses %}
            characters.push(
                {
                    name: "{{cpu_horse.name}}",
                    emoji:"{{cpu_horse.emoji}}",
                    speed: {{cpu_horse.speed}},
                    stamina: {{cpu_horse.stamina}},
                    luck: {{cpu_horse.luck}},
                    traits: [
                        {% for trait in cpu_horse.traits.all %}
                            {
                                id: {{ trait.id }},
                                name: "{{ trait.name }}",
                                description: "{{ trait.description }}"
                            }{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    ]
                }
            );
        {% endfor %}

        var weatherAndTimeArray = setWeatherAndTime(characters); 
        var weatherInfo = weatherAndTimeArray[0];
        var timeInfo = weatherAndTimeArray[1];
      //  console.log(weatherInfo + timeInfo);//æœ¬ç•ªã¯æ¶ˆã™

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç³»ã®ç‰¹æ€§æ¡ä»¶åˆ†å²

        for(let i = 0; i < characters.length; ++i) {
            if (characters[i].traits.some(trait => trait.id === 5) && (weatherInfo === "snow")) {//é›ªã‹ã
                    characters[i].speed *= 1.1;
                    characters[i].stamina *= 1.1;
                    characters[i].luck *= 1.1;
            }  
            if (characters[i].traits.some(trait => trait.id === 6) && (weatherInfo === "thunder")) {//é¿é›·é‡
                    characters[i].speed *= 1.1;
                    characters[i].stamina *= 1.1;
                    characters[i].luck *= 1.1;
            }
            if (characters[i].traits.some(trait => trait.id === 7) && (weatherInfo === "sunny")) {//å…‰åˆæˆ
                    characters[i].speed *= 1.1;
                    characters[i].stamina *= 1.1;
                    characters[i].luck *= 1.1;
            }
            if (characters[i].traits.some(trait => trait.id === 8) && (weatherInfo === "rain")) {//ã™ã„ã™ã„
                    characters[i].speed *= 1.1;
                    characters[i].stamina *= 1.1;
                    characters[i].luck *= 1.1;
            }
            if (characters[i].traits.some(trait => trait.id === 12)) {
                // If such a character exists, reduce all characters' stats by 10%
                characters.forEach(character => {
                    character.speed *= 0.75;
                    character.stamina *= 0.75;
                    character.luck *= 0.75;
                    // Do the same for other stats if there are any...
                });
            }

            if (characters[i].traits.some(trait => trait.id === 19)) {
                // If such a character exists, increase speed by 10% and reduce stamina by 10%
                characters[i].speed *= 1.1;
                characters[i].stamina *= 0.9;
            }

            if (characters[i].traits.some(trait => trait.id === 20)) {
                // If such a character exists, increase stamina by 10% and reduce luck by 10%
                characters[i].stamina *= 1.1;
                characters[i].speed *= 0.9;
            }

            if (characters[i].traits.some(trait => trait.id ===21)) {
                // If such a character exists, increase luck by 30% and reduce speed and stamina by 10%
                characters[i].luck *= 1.3;
                characters[i].speed *= 0.9;
                characters[i].stamina *= 0.9;
            }


            if (characters[i].traits.some(trait => trait.id ===28)) {
                if (timeInfo=='morning') {
                    characters[i].luck *= 1.1;
                } else if (timeInfo=='night') {
                    characters[i].speed *= 0.95;
                }
            }

            if (characters[i].traits.some(trait => trait.id ===29)) {
                if (timeInfo=='noon') {
                    characters[i].speed *= 1.1;
                }
            }

            if (characters[i].traits.some(trait => trait.id ===30)) {
                if (timeInfo=='night') {
                    characters[i].stamina *= 1.1;
                } else if (timeInfo=='morning') {
                    characters[i].speed *= 0.9;
                }
            }


            if (characters[i].traits.some(trait => trait.id ===46)) {
                // Calculate the average stats of the other horses
                let otherCharacters = characters.filter((_, index) => index !== i);
                let avgSpeed = otherCharacters.reduce((total, character) => total + character.speed, 0) / otherCharacters.length;
                let avgStamina = otherCharacters.reduce((total, character) => total + character.stamina, 0) / otherCharacters.length;
                let avgLuck = otherCharacters.reduce((total, character) => total + character.luck, 0) / otherCharacters.length;

                // Set the character's stats to the average of its own stats and the average stats of the other horses
                characters[i].speed = (characters[i].speed + avgSpeed) / 2;
                characters[i].stamina = (characters[i].stamina + avgStamina) / 2;
                characters[i].luck = (characters[i].luck + avgLuck) / 2;
            }

            if (characters[i].traits.some((trait) => trait.id ===47)){
                counts[i] = -10;
            }

            if (characters[i].traits.some(trait => trait.id ===38)) {//ã‚­ãƒ£ãƒ©ã®çµµæ–‡å­—ã‚’å–å¾—ï¼ˆå¿è€…ï¼‰
                special38.splice(i, 0 , characters[i].emoji);
            }

            if (characters[i].traits.some(trait => trait.id ===40)) {//å…¨æ•µã®å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹5%æ¸›å°‘ï¼‹è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ¸›å°‘ã®åˆè¨ˆã®50%ä¸ŠãŒã‚‹ï¼ˆå¸ã„ã¾ã™ï¼‰
                var totalSpeeds = 0;
                var totalStaminas = 0;
                var totalLucks = 0;


                for(let character of characters) {
                    if (!(character == characters[i])) {
                        totalSpeeds += character.speed * 0.05;
                        totalStaminas += character.stamina * 0.05;
                        totalLucks += character.luck * 0.05;

                        character.speed *= 0.95;
                        character.stamina *= 0.95;
                        character.luck *= 0.95;
                    }
                }

                characters[i].speed += totalSpeeds / 2;
                characters[i].stamina += totalStaminas / 2;
                characters[i].luck += totalLucks / 2;
            }

            if (characters[i].traits.some(trait => trait.id ===41)) {//å…¨æ•µã®å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹7%æ¸›å°‘ï¼‹è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ¸›å°‘ã®åˆè¨ˆã®50%ä¸ŠãŒã‚‹ï¼ˆå¸ã„ã¾ã™å¸ã„ã¾ã™ï¼‰
                var totalSpeeds = 0;
                var totalStaminas = 0;
                var totalLucks = 0;


                for(let character of characters) {
                    if (!(character == characters[i])) {
                        totalSpeeds += character.speed * 0.07;
                        totalStaminas += character.stamina * 0.07;
                        totalLucks += character.luck * 0.07;

                        character.speed *= 0.93;
                        character.stamina *= 0.93;
                        character.luck *= 0.93;
                    }
                }

                characters[i].speed += totalSpeeds / 2;
                characters[i].stamina += totalStaminas / 2;
                characters[i].luck += totalLucks / 2;
            }
            if (characters[i].traits.some(trait => trait.id ===42)) {//å…¨æ•µã®å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹10%æ¸›å°‘ï¼‹è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ¸›å°‘ã®åˆè¨ˆã®50%ä¸ŠãŒã‚‹ï¼ˆã¨ã“ã¨ã‚“å¸ã„ã¾ã™ï¼‰
                var totalSpeeds = 0;
                var totalStaminas = 0;
                var totalLucks = 0;


                for(let character of characters) {
                    if (!(character == characters[i])) {
                        totalSpeeds += character.speed * 0.1;
                        totalStaminas += character.stamina * 0.1;
                        totalLucks += character.luck * 0.1;

                        character.speed *= 0.9;
                        character.stamina *= 0.9;
                        character.luck *= 0.9;
                    }
                }

                characters[i].speed += totalSpeeds /2;
                characters[i].stamina += totalStaminas /2;
                characters[i].luck += totalLucks /2;
            }
            
            if (characters[i].traits.some(trait => trait.id === 43)) {//ãƒ‰ãƒªãƒ¼ãƒ ãƒãƒ¼ãƒ ãŒï¼’ä½“ä»¥ä¸Šã„ã‚‹ã¨å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ15%ä¸Šæ˜‡ï¼ˆãƒ‰ãƒªãƒ¼ãƒ ãƒãƒ¼ãƒ ï¼‰
                var traitsNameList = characters.map(character => character.traits.map(trait => trait.name)).reduce((acc, val) => acc.concat(val), []);
                var isDreamTeamTwice = traitsNameList.filter(name => name === "ãƒ‰ãƒªãƒ¼ãƒ ãƒãƒ¼ãƒ ").length >= 2;

                if (isDreamTeamTwice) {
                    characters[i].speed *= 1.15;
                    characters[i].stamina *= 1.15;
                    characters[i].luck *= 1.15;
                }

                //console.log(traitsNameList);
            }
            
            if (characters[i].traits.some(trait => trait.id === 44)) {//è‡ªåˆ†ã‚’å«ã‚€èª°ã‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ30ï¼…æ¸›å°‘(ä¸å¹¸ã‚’å‘¼ã¶ã‚‚ã®)
                var randomCharaNumber = Math.floor(Math.random() * 4);
                var randomStatusNumber = Math.floor(Math.random() * 3 + 1);

                //console.log("Random Status Number: " + randomStatusNumber);
                //console.log("Random Chara Number: " + randomCharaNumber);

                if (randomStatusNumber == 1) {
                    characters[randomCharaNumber].speed *= 0.7;
                } else if (randomStatusNumber == 2) {
                    characters[randomCharaNumber].stamina *= 0.7;
                } else {
                    characters[randomCharaNumber].luck *= 0.7;
                }
            }
        }

        //ä»¥ä¸‹ãŒå‘¨æœŸ(speeds)ã¨ç¢ºç‡(probabilities)ã®è¨ˆç®—å¼
        for(let i = 0; i < characters.length; ++i) {
            let baseSpeed = 450 - (characters[i].speed*3 + characters[i].stamina/2 + characters[i].luck/10)*150/360;
            let baseProbability = (50 + ((characters[i].speed + characters[i].stamina*2 + characters[i].luck*5)*25/700))/100;

            // ç‰¹æ€§IDãŒ22ã‚’æŒã¤ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ä¹±æ•°å¹…ã‚’10ï¼…ã«
            let variationRate = characters[i].traits.some(trait => trait.id === 22) ? 0.1 : 0.02;

            // ä¹±æ•°ã‚’ç”Ÿæˆã—ã¦ã€ãã‚Œã‚’Â±1%ã®å¤‰å‹•ã¨ã™ã‚‹
            let speedVariation = baseSpeed * ((Math.random() * variationRate * 2) - variationRate);
            let probabilityVariation = baseProbability * ((Math.random() * variationRate * 2) - variationRate);

            speeds[i] = baseSpeed + speedVariation;
            probabilities[i] = baseProbability + probabilityVariation;
        }
        let baseSpeeds = [...speeds];
        let baseProbabilities = [...probabilities];





        let table = document.createElement("table"); 
        table.className = "table table-striped";
        let header = document.createElement("tr"); 
        
        header.innerHTML = `<th> ã€€ãƒ¬ãƒ¼ãƒ³ã€€ </th>
                            <th> ã€€åå‰ã€€ </th>
                            <th>ã€€ã‚¹ã‚¿ãƒŸãƒŠã€€</th>
                            <th>ã€€ã‚¹ãƒ”ãƒ¼ãƒ‰ã€€</th>
                            <th>ã€€é‹ã€€</th>
                            <th> ã€€å‘¨æœŸã€€ </th>
                            <th> ã€€ç¢ºç‡ã€€ </th>
                            <th> ã€€ç‰¹æ€§ </th>`;
        
        table.appendChild(header); 

        document.getElementById('toggleButton').addEventListener('click', function () {
        var table = document.getElementById('myTable');
        var button = document.getElementById('toggleButton');

          // è¡¨ãŒç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã—ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œè¡¨ç¤ºã€ã«æ›´æ–°
        if (table.style.display !== 'none') {
            table.style.display = 'none';
            button.textContent = 'è¡¨ç¤º';
        }
        // è¡¨ãŒç¾åœ¨éè¡¨ç¤ºã®å ´åˆã¯è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œéè¡¨ç¤ºã€ã«æ›´æ–°
        else {
            table.style.display = '';
            button.textContent = 'éè¡¨ç¤º';
        }
        });

  
 

    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.getElementById('toggleButton').addEventListener('click', function() {
        if (tableContainer.style.display === "none") {
            tableContainer.style.display = "block";
        } else {
            tableContainer.style.display = "none";
        }
    });


        let raceTableElement = document.getElementById("racetable");
        raceTableElement.appendChild(table);

        document.body.appendChild(table); 
        document.getElementById('racetable').appendChild(table);// Add the table to the body

        updateTable();

        document.getElementById('start-race').addEventListener('click', function() {
            this.style.display = 'none';//å‡ºèµ°ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
            var countdownModal = $('#countdownModal');
            var countdown = $('#countdown');
            countdownModal.modal('show');
            countdown.text('3');
        
            // ãƒ¬ãƒ¼ã‚¹ä¸­ã®BGMã‚’å†ç”Ÿ
            var racebgm = "{% static 'audio/race_bgm.mp3' %}";


            for(let i = 0; i < characters.length; ++i) {
                // trait.id 31ã®æ™‚ã«ç¥­ã‚Šã£ã½ã„BGMãŒæµã‚Œã‚‹ï¼ˆãŠç¥­ã‚Šç”·)
                if (characters[i].traits.some(trait => trait.id === 31)) {
                    racebgm = "{% static 'audio/omaturi.mp3' %}";
                    break;
                // trait.id 32ã®æ™‚ã«ãƒ©ã‚¹ãƒœã‚¹ã£ã½ã„BGMãŒæµã‚Œã‚‹ï¼ˆãƒ©ã‚¹ãƒœã‚¹)
                }else if (characters[i].traits.some(trait => trait.id === 32)) {
                    racebgm = "{% static 'audio/vsmaou.mp3' %}";
                    break;
                // trait.id 33ã®æ™‚ã«ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼BGMãŒæµã‚Œã‚‹ï¼ˆã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼)
                }else if (characters[i].traits.some(trait => trait.id === 33)) {
                    racebgm = "{% static 'audio/syainingstar.mp3' %}";
                    break;
                // trait.id 34ã®æ™‚ã«ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ã®æˆ¦é—˜æ›²ãŒæµã‚Œã‚‹ï¼ˆãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ å¥½ã)
                }else if (characters[i].traits.some(trait => trait.id === 34)) {
                    racebgm = "{% static 'audio/retoro_bgm.mp3' %}";
                    break;
                // trait.id 35ã®æ™‚ã«ã‚‰ã‚‰ã‚‰ã‚³ãƒƒãƒšãƒ‘ãƒ³BGMãŒæµã‚Œã‚‹ï¼ˆã‚‰ã‚‰ã‚‰ã‚³ãƒƒãƒšãƒ‘ãƒ³)
                }else if (characters[i].traits.some(trait => trait.id === 35)) {
                    racebgm = "{% static 'audio/rararakopepan.mp3' %}";
                    break;
                // trait.id 36ã®æ™‚ã«8ã®å­—ã‚µãƒ¼ã‚­ãƒƒãƒˆBGMãŒæµã‚Œã‚‹ï¼ˆã‚µãƒ¼ã‚­ãƒƒãƒˆ)
                }else if (characters[i].traits.some(trait => trait.id === 36)) {
                    racebgm = "{% static 'audio/surkit.mp3' %}";
                    break;
                // trait.id 37ã®æ™‚ã«ã‚°ãƒ«ãƒ¡ãƒ¬ãƒ¼ã‚¹ã£ã½ã„BGMãŒæµã‚Œã‚‹ï¼ˆæ˜Ÿã®)
                }else if (characters[i].traits.some(trait => trait.id === 37)) {
                    racebgm = "{% static 'audio/gurume_race.mp3' %}";
                    break;
                }
            }

            var bgm = new Audio(racebgm);
            bgm.volume = 1; // éŸ³é‡1% 
            bgm.play();

            // document.body.classList.add("thunderstorm");
            

            setTimeout(function() {
                countdown.text('2');
                setTimeout(function() {
                    countdown.text('1');
                    setTimeout(function() {
                        countdown.text('ã‚¹ã‚¿ãƒ¼ãƒˆï¼');
                        setTimeout(function() {
                            countdownModal.modal('hide');
                            // Start the race here
                            var intervals = [];
                            for(let i = 0; i < characters.length; ++i) {
                                // If the character has trait.id 13, start 3 squares ahead
                                if (characters[i].traits.some(trait => trait.id === 13)) {
                                    var div = document.getElementById('editable' + (i + 1));

                                    // Check if the character also has trait.id 14
                                    if (characters[i].traits.some(trait => trait.id === 14)) {
                                        // If yes, insert the special character instead of spaces
                                        div.innerHTML = `<span class="emoji">${special14}</span><span class="emoji">${special14}</span><span class="emoji">${special14}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 15)){
                                        // If no, insert spaces as usual
                                        div.innerHTML = `<span class="emoji">${special15}</span><span class="emoji">${special15}</span><span class="emoji">${special15}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 16)){
                                        // If no, insert spaces as usual
                                        div.innerHTML = `<span class="emoji">${special16}</span><span class="emoji">${special16}</span><span class="emoji">${special16}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 17)){
                                        // If no, insert spaces as usual
                                        div.innerHTML = `<span class="emoji">${special17}</span><span class="emoji">${special17}</span><span class="emoji">${special17}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 18)){
                                        // If no, insert spaces as usual
                                        div.innerHTML = `<span class="emoji">${special18}</span><span class="emoji">${special18}</span><span class="emoji">${special18}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 38)){
                                        div.innerHTML = `<span class="emoji" style="opacity:0.1;">${special38[i]}</span><span class="emoji" style="opacity:0.1;">${special38[i]}</span><span class="emoji" style="opacity:0.1;">${special38[i]}</span>` + div.innerHTML;
                                    } else if (characters[i].traits.some(trait => trait.id === 39)){
                                        div.innerHTML = `<span class="emoji">${special39}</span><span class="emoji">${special39}</span><span class="emoji">${special39}</span>` + div.innerHTML;
                                    } else {
                                        // If no, insert spaces as usual
                                        div.innerHTML = `<span class="emoji">${space}</span><span class="emoji">${space}</span><span class="emoji">${space}</span>` + div.innerHTML;
                                    }
                            
                                    // Increment counts[i] by 3
                                    counts[i] += 3;
                                    // Play the sound
                                    var soundFileUrl = "{% static 'audio/huraing.mp3' %}";
                                    var audio = new Audio(soundFileUrl);
                                    audio.volume = 0.01; // éŸ³é‡3% 
                                    audio.play();
                                }
                        

                                // The first 5 counts are start dash. The higher the lucky, the faster.
                                startDashSpeeds[i] = speeds[i];
                                var startDashProbability = characters[i].luck/100/2;
                                startDashProbability += characters[i].traits.some(trait => trait.id === 10) ? 0.3 : 0;
                                //console.log("Start Dash Probability for character " + i + ": " + startDashProbability); //ãƒ‡ãƒãƒƒã‚¯ç”¨
                                if (Math.random() < (startDashProbability)) {
                                    speeds[i] -= 150;
                                    startDashChanged[i] = true;
                                    updateTable();
                                    //console.log("Start Dash activated for character " + i); //ãƒ‡ãƒãƒƒã‚¯ç”¨
                                }
                                let moveEmoji = function() {
                                    var div = document.getElementById('editable' + (i + 1));
                                    if(counts[i] < 70){
                                        var soundFileUrl = "{% static 'audio/2go.mp3' %}";
                                        if (characters[i].traits.some(trait => trait.id === 23) && !traitsDisabled) {
                                            // Check if there are other characters within 3 squares
                                            let isNear = counts.some((count, index) => 
                                                index !== i && Math.abs(count - counts[i]) <= 3
                                            );
                                            if (isNear && !traits23Changed[i]) {
                                                speeds[i] = baseSpeeds[i] / 1.05;
                                                probabilities[i] = baseProbabilities[i] * 1.05;
                                                traits23Changed[i] = true;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            } else {
                                                speeds[i] = baseSpeeds[i];
                                                probabilities[i] = baseProbabilities[i];
                                                traits23Changed[i] = false;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            }
                                        }
                                        if (characters[i].traits.some(trait => trait.id === 24) && !traits24Changed[i] && !traitsDisabled) {
                                            // Check if the character is in the first place
                                            let isFirst = counts[i] >= Math.max(...counts);
                                            if (isFirst) {
                                                speeds[i] = baseSpeeds[i] / 0.95;
                                                probabilities[i] = baseProbabilities[i] * 0.95;
                                                traits24Changed[i] = true;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            } else {
                                                speeds[i] = baseSpeeds[i];
                                                probabilities[i] = baseProbabilities[i];
                                                traits24Changed[i] = false;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            }
                                        }
                                        if (characters[i].traits.some(trait => trait.id === 25) && !traitsDisabled) {
                                            // Check if the character is in the first place
                                            let isFirst = counts[i] >= Math.max(...counts);
                                            if (isFirst) {
                                                speeds[i] = baseSpeeds[i] / 1.05;
                                                probabilities[i] = baseProbabilities[i] * 1.05;
                                                traits25Changed[i] = true;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            } else {
                                                speeds[i] = baseSpeeds[i];
                                                probabilities[i] = baseProbabilities[i];
                                                traits25Changed[i] = false;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            }
                                        }
                                        if (characters[i].traits.some(trait => trait.id === 26) && !traitsDisabled) {
                                            // Check if the character is in the last place
                                            let isLast = counts[i] <= Math.min(...counts);
                                            if (isLast) {
                                                speeds[i] = baseSpeeds[i] / 1.2;
                                                probabilities[i] = baseProbabilities[i] * 1.2;
                                                traits26Changed[i] = true;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            } else {
                                                speeds[i] = baseSpeeds[i];
                                                probabilities[i] = baseProbabilities[i];
                                                traits26Changed[i] = false;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            }
                                        }

                                        if (characters[i].traits.some(trait => trait.id === 27) && !traitsDisabled) {
                                            // Check if the character is in the last place
                                            let isLast = counts[i] <= Math.min(...counts);
                                            if (isLast) {
                                                speeds[i] = baseSpeeds[i] / 0.95;
                                                probabilities[i] = baseProbabilities[i] * 0.95;
                                                traits27Changed[i] = true;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            } else {
                                                speeds[i] = baseSpeeds[i];
                                                probabilities[i] = baseProbabilities[i];
                                                traits27Changed[i] = false;
                                                speedChanged[i] = false;
                                                lateSpeedChanged[i] = false;
                                                lastSprintChanged[i] = false;
                                                updateTable();
                                            }
                                        }
                                        if (characters[i].traits.some(trait => trait.id === 47)&&counts[i] >= 0 && !traits46Changed[i] && !traitsDisabled) {
                                            baseSpeeds[i] = speeds[i];
                                            speeds[i] = speeds[i] / 1.2;
                                            baseProbabilities[i] = probabilities[i];
                                            probabilities[i] = probabilities[i] * 1.2;
                                            traits46Changed[i] = true;
                                            speedChanged[i] = false;
                                            lateSpeedChanged[i] = false;
                                            lastSprintChanged[i] = false;
                                            updateTable();
                                        }
                                        if (characters[i].traits.some(trait => trait.id ===49) && !traits49Changed[i] && counts.some(count => count >= 70) && !traitsDisabled){
                                            speeds[i] = baseSpeeds[i] / 1.5;
                                            probabilities[i] = baseProbabilities[i] * 1.5;
                                            traits49Changed[i] = true;
                                            speedChanged[i] = false;
                                            lateSpeedChanged[i] = false;
                                            lastSprintChanged[i] = false;
                                            updateTable();
                                        }
                                        var footprint;
                                        var audio = new Audio(soundFileUrl);
                                        // trait.id 14ã®æ™‚ã«ğŸŒ¸ã‚’é“ã«å’²ã‹ã›ã‚‹å‡¦ç†ï¼ˆã¯ãªã•ã‹ã˜ã„ã•ã‚“)
                                        if (characters[i].traits.some(trait => trait.id === 14)) {
                                            footprint = special14;
                                        // trait.id 15ã®æ™‚ã«ğŸ’£ã‚’é“ã«ç½®ãå‡¦ç†ï¼ˆãƒœãƒ³ãƒãƒ¼ãƒãƒ³)
                                        } else if (characters[i].traits.some(trait => trait.id === 15)) {
                                            footprint = special15;
                                        // trait.id 16ã®æ™‚ã«ğŸ†ã‚’é“ã«å’²ã‹ã›ã‚‹å‡¦ç†ï¼ˆèŠ±ç«å¸«)
                                        } else if (characters[i].traits.some(trait => trait.id === 16)) {
                                            footprint = special16;
                                        // trait.id 17ã®æ™‚ã«ğŸ‘ ã‚’é“ã«å¿˜ã‚Œã‚‹å‡¦ç†ï¼ˆã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©)
                                        } else if (characters[i].traits.some(trait => trait.id === 17)) {
                                            footprint = special17;
                                        // trait.id 18ã®æ™‚ã«ğŸã‚’é“ã«é…ã‚‹å‡¦ç†ï¼ˆã‚µãƒ³ã‚¿ã•ã‚“)
                                        } else if (characters[i].traits.some(trait => trait.id === 18)) {
                                            footprint = special18;
                                        } else if (characters[i].traits.some(trait => trait.id === 38)) {//æ®‹åƒã‚’æ®‹ã™
                                            //console.log("emoji : " + special38[i]);

                                            footprint = special38[i];
                                        } else if (characters[i].traits.some(trait => trait.id === 39)) {//30%ã§ğŸ’©ã‚’ç½®ã
                                            if (Math.random() < 0.3) {
                                                footprint = special39;
                                            } else {
                                                footprint = space;
                                            }
                                        // ãã‚Œä»¥å¤–ã®æ™‚ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹å‡¦ç†ï¼ˆé€šå¸¸æ™‚ï¼‰
                                        } else {
                                            footprint = space;
                                        }
                                        if(Math.random() < probabilities[i] && counts[i] < 70){
                                            if (Math.random() < characters[i].luck / 100 * 0.15){
                                                counts[i]+=2;
                                                if(counts[i]>=0){
                                                    if (!(characters[i].traits.some(trait => trait.id === 38))) {
                                                        div.innerHTML = `<span class="emoji">${footprint}</span>` + `<span class="emoji">${footprint}</span>` + div.innerHTML;
                                                    } else {
                                                        div.innerHTML = `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + div.innerHTML;
                                                    }
                                                }
                                                // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
                                                audio.volume = 0.03; // éŸ³é‡3%
                                                audio.play();
                                            } else{
                                                counts[i] += 1;
                                                if(counts[i]>=0){
                                                    if (!(characters[i].traits.some(trait => trait.id === 38))) {
                                                        div.innerHTML = `<span class="emoji">${footprint}</span>` + div.innerHTML;
                                                    } else {
                                                        div.innerHTML = `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + div.innerHTML;
                                                    }
                                                }
                                            }
                                        } else {
                                            failCounts[i]++;
                                            if((characters[i].traits.some(trait => trait.id === 48)) && failCounts[i] == 8 && !traitsDisabled){
                                                counts[i] += 3;
                                                failCounts[i] = 0;
                                                //console.log(`counts: ${counts[i]}`, "character", characters[i]);
                                                if(counts[i]>=0){
                                                    if (!(characters[i].traits.some(trait => trait.id === 38))) {
                                                        div.innerHTML = `<span class="emoji">${footprint}</span>`+ `<span class="emoji">${footprint}</span>` + `<span class="emoji">${footprint}</span>` + div.innerHTML;
                                                    } else {
                                                        div.innerHTML = `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + `<span class="emoji" style="opacity:0.3;">${footprint}</span>` + div.innerHTML;
                                                    }
                                                }
                                            }
                                        }
                                        if(counts[i] >= 5 && startDashChanged[i]){  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥çµ‚äº†å¾Œã¯é€Ÿåº¦ã‚’å…ƒã«æˆ»ã™
                                            speeds[i] = startDashSpeeds[i];
                                            startDashChanged[i] = false;
                                            clearInterval(intervals[i]);
                                            intervals[i] = setInterval(moveEmoji, speeds[i]);
                                            updateTable();
                                        }
                                        if(counts[i] >= 30 && !speedChanged[i]){  // ãƒ¬ãƒ¼ã‚¹ã®ä¸­ç›¤ã§é€Ÿåº¦ã‚’å¤‰æ›´
                                            speeds[i] += 50-characters[i].stamina*50/100;  // é€Ÿåº¦ã‚’å¢—ã‚„ã™ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é€²è¡Œé€Ÿåº¦ãŒæ¸›å°‘ã—ã¾ã™
                                            probabilities[i] -= 0.02-characters[i].stamina/100*0.02
                                            speedChanged[i] = true;
                                            clearInterval(intervals[i]);
                                            intervals[i] = setInterval(function(){moveEmoji(i);}, speeds[i]);
                                            updateTable();
                                        }
                                        if(counts[i] >= 45 && !lateSpeedChanged[i]){ //){
                                            speeds[i] += 80-characters[i].stamina*80/100;
                                            probabilities[i] -= 0.03-characters[i].stamina/100*0.03
                                            lateSpeedChanged[i] = true;
                                            clearInterval(intervals[i]);
                                            intervals[i] = setInterval(moveEmoji, speeds[i]);
                                            updateTable();
                                        }

                                        if(counts[i]>=50 && characters[i].traits.some(trait => trait.id === 45) && !traits45Changed[i]){
                                            traits45Changed[i] = true;
                                            let oldProbabilities = [...probabilities];
                                            traitsDisabled = true;
                                            // å…¨ã¦ã®ç¢ºç‡ã‚’0ã«è¨­å®š
                                            for (let j = 0; j < probabilities.length; j++) {
                                                probabilities[j] = 0;
                                                updateTable();
                                            }
                                            
                                            // Play the sound
                                            
                                            var soundFileUrl = "{% static 'audio/timestop.mp3' %}";
                                            var audio45 = new Audio(soundFileUrl);
                                            audio45.volume = 0.5; // éŸ³é‡3% 
                                            audio45.play();    
                                        
                                            var messageElement = document.getElementById('message45');
                                            messageElement.textContent = 'ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ‘ãƒ¼ç™ºå‹•ï¼æ™‚ã‚ˆã¨ã¾ã‚Œï¼';
                                            messageElement.style.display = 'block';

                                        

                                             // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                                            setTimeout(function() {
                                                messageElement.style.display = 'none';
                                                probabilities = [...oldProbabilities];
                                                updateTable();
                                                traitsDisabled = false;
                                                counts[i] += 3;
                                                var div = document.getElementById('editable' + (i + 1));
                                                div.innerHTML = `<span class="emoji">${space}</span><span class="emoji">${space}</span><span class="emoji">${space}</span>` + div.innerHTML;
                                            }, 3000);
                                        }

                                        var lastSprintCount = characters[i].traits.some(trait => trait.id === 11) ? 55 : 60;
                                        if(counts[i] >= lastSprintCount && !lastSprintChanged[i]){ // ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆæ©Ÿèƒ½
                                            speeds[i] -= (characters[i].stamina*2+characters[i].speed*3)*150/500;
                                            lastSprintChanged[i] = true;
                                            clearInterval(intervals[i]);
                                            intervals[i] = setInterval(moveEmoji, speeds[i]);
                                            updateTable();
                                        }
                                    } else {
                                        clearInterval(intervals[i]);
                                        var goalMessage = document.createElement('div');

                                        goalMessage.className = 'goal-message';
                                        if (place === 1) {
                                            goalMessage.textContent =  emojis[i] + ' ã€€é †ä½ï¼š' + place + 'ä½ğŸ¥‡ ';
                                            goalMessage.style.backgroundColor = 'gold';  // Gold for 1st place
                                        } else if (place === 2) {
                                            goalMessage.textContent =  emojis[i] + ' ã€€é †ä½ï¼š' + place + 'ä½ğŸ¥ˆ ';
                                            goalMessage.style.backgroundColor = 'silver';  // Silver for 2nd place
                                        } else if (place === 3) {
                                            goalMessage.textContent =  emojis[i] + ' ã€€é †ä½ï¼š' + place + 'ä½ğŸ¥‰ ';
                                            goalMessage.style.backgroundColor = '#cd7f32';  // Bronze for 3rd place
                                        } else {
                                            goalMessage.textContent =  emojis[i] + ' ã€€é †ä½ï¼š' + place+ 'ä½ ';
                                            goalMessage.style.backgroundColor = '#ADD8E6'; // Light blue for other places
                                        }
                                        document.getElementById('goal-messages').appendChild(goalMessage);


                                        // finishedEmojis.push('é †ä½' + place + 'ï¼š' + characters[i].name + emojis[i] + ', speed: ' + characters[i].speed + ', stamina: ' + characters[i].stamina + ', luck: ' + characters[i].luck+ ' Trial Frequency  ' + speeds[i].toFixed(2)  + ', Probability : ' + probabilities[i].toFixed(2));
                                        //ã‚´ãƒ¼ãƒ«æ™‚ã®åŠ¹æœéŸ³
                                        var soundFileUrl = "{% static 'audio/goal.mp3' %}";
                                        var audiogoal = new Audio(soundFileUrl);
                                        audiogoal.volume = 0.03; // éŸ³é‡3% 
                                        audiogoal.play();
                                        finishedEmojis.push('é †ä½' + place + 'ï¼š' + characters[i].name + emojis[i] )
                                        if (i==0 && !positionFrag){
                                            $j.ajax({
                                                url: '/race/set_session/',  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                                                method: 'POST',
                                                data: {
                                                    'horse_position': place,
                                                    'csrfmiddlewaretoken': '{{ csrf_token }}' 
                                                }
                                            });
                                            positionFrag = true;
                                        }
                                        place++;
                                        if(finishedEmojis.length == characters.length){
                                            //document.body.innerHTML += '<br>' + finishedEmojis.join('<br>');
                                            // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚´ãƒ¼ãƒ«ã—ãŸå¾Œ
                                            localStorage.setItem('finishedEmojis', JSON.stringify(finishedEmojis));
                                            //console.log(finishedEmojis);  finishedEmojisã®ä¸­èº«ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                                        
                                            // 2ç§’å¾Œã«é †ä½ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ç§»å‹•
                                            setTimeout(function() {
                                                // window.location.href = 'results.html'; // 'results.html'ã¯é †ä½ä¸€è¦§ãƒšãƒ¼ã‚¸ã®URL
                                                window.location.href = '/race/results/{{horse.id}}/'; // '/results/'ã¯é †ä½ä¸€è¦§ãƒšãƒ¼ã‚¸ã®URL

                                            }, 2000);
                                        }
                                    }
                                };
                                intervals[i] = setInterval(moveEmoji, speeds[i]);
                            }
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        });

    </script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

</body>
</html>